# Firebase App Distributionへの自動配信
# トリガー: releaseブランチへのpush
name: CD Firebase

on:
  push:
    branches: [release]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Firebase App Distribution
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # 1. コードをチェックアウト
      - name: Checkout
        uses: actions/checkout@v4

      # 2. JDK 17をセットアップ
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Gradleをセットアップ
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # 4. google-services.jsonを復元（dev環境）
      - name: Restore google-services.json (dev)
        env:
          GOOGLE_SERVICES_JSON_DEV: ${{ secrets.GOOGLE_SERVICES_JSON_DEV }}
        run: |
          mkdir -p app/src/dev
          echo "$GOOGLE_SERVICES_JSON_DEV" | base64 --decode > app/src/dev/google-services.json

      # 5. google-services.jsonを復元（prod環境）
      #    devReleaseビルドでもprodのgoogle-services.jsonが参照される場合があるため
      - name: Restore google-services.json (prod)
        env:
          GOOGLE_SERVICES_JSON_PROD: ${{ secrets.GOOGLE_SERVICES_JSON_PROD }}
        run: |
          mkdir -p app/src/prod
          echo "$GOOGLE_SERVICES_JSON_PROD" | base64 --decode > app/src/prod/google-services.json

      # 6. 署名鍵を復元（appディレクトリに配置）
      - name: Restore signing key
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 --decode > app/upload-keystore.jks

      # 7. devRelease APKをビルド（署名付き）
      - name: Build devRelease APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew assembleDevRelease

      # 8. サービスアカウントをデコード
      - name: Decode service account
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          echo "$FIREBASE_SERVICE_ACCOUNT" | base64 --decode > firebase-service-account.json

      # 9. Firebase App Distributionにアップロード
      - name: Upload to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID_DEV }}
          serviceCredentialsFile: firebase-service-account.json
          groups: testers
          file: app/build/outputs/apk/dev/release/app-dev-release.apk
          releaseNotes: |
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
